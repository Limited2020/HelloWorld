Attribute VB_Name = "VBT_basic_PartialGood_XXXX"
Option Explicit

''=====================================
''   Partial Good Flag Sturcture Definition
''=====================================

Public Type Type_PartialGood_Flag
    cItemName As String
    iValue As New SiteLong
End Type

Public CurrentFlowPGPassFlag As Type_PartialGood_Flag
Public PreCheckFlowPGPassFlag As Type_PartialGood_Flag
Public CurrentFlowModulePassFlag() As Type_PartialGood_Flag
Public PreCheckFlowModulePassFlag() As Type_PartialGood_Flag
Public FlowModuleFlag() As Type_PartialGood_Flag


''=====================================
''   Partial Good Sturcture Definition
''=====================================

Type PG_Info_Structure
    WGL_Name() As String
    PG_Type() As String
    IncludeModule() As String
    Pin_Cycle_Array() As String
End Type

Global PG_Info  As PG_Info_Structure

'Use Dictionary to quickly find pattern index, key is wgl name in PG_Info work sheet, item is index
Global FindPatternIndex_Dct As New Dictionary

'Use Dictionary to quickly find module index, key is module name defined in global const string, item is index
Global FindModuleIndex_Dct As New Dictionary

'User can modify PG module name in this string, PG result for each module is stored in DSPwave reference to the order in this string
Global Const USER_DEFINE_MODULENAME As String = "DSP0/DSP1/DSP2/DSP3/FFT0/FFT1/SAMP0/SAMP1"
'User define these string const accroding to the PG Rules,it should be included in USER_DEFINE_MODULENAME,used for PG bining
Global Const USER_DEFINE_DSPSCluster As String = "DSP0/DSP1/DSP2/DSP3"
Global Const USER_DEFINE_FFTCluster As String = "FFT0/FFT1"
Global Const USER_DEFINE_SAMPCluster As String = "SAMP0/SAMP1"


Global glb_PG_FlowResult_Dspwave As New DSPWave
Global glb_PG_FlowResult_AVS_Dspwave As New DSPWave
Global glb_Module_Count As Long
Global glb_PG_DebugMode As Boolean
Global glb_PGFirstFail_Flag_SBool As New SiteBoolean      'Init False, record if the first fail is found, if found then glb_PGFirstFail_Flag_SBool=True
Global glb_PGFirstFail_UpdateDone_SBool As New SiteBoolean
Global glb_PGFisrtFail_BinNum_SLng As New SiteLong       'Record the first found BinNum
Global glb_PGFisrtFail_SortNum_SLng As New SiteLong      'Record the first found SortNum
Public PG_Judge_Slng As New SiteLong   '''Used In postJudge for datalog print
Global glb_IsPGInfoLoaded_Bool As Boolean

'''the value assignment of next two global elment is not fix,because AVS process hasn't fix,it's temp for engineer program  20200316 Sean
Global glb_PG_GRD_Sdbl As New SiteDouble
Global glb_PWR_GRD_Sdbl As New SiteDouble
Public PGCaredModule_Result_SBool As New SiteBoolean
Public AVS_Enable As Boolean                    ''set true in AVS test,stands for whether is AVS test
Public AVS_LP_Enable_SBool As New SiteBoolean   ''set true in AVS LP process
Public AVS_HP_Enable_SBool As New SiteBoolean   ''set true in AVS HP process
Public H_PWR_FLag_PG As New SiteBoolean
Public glb_BinOut_Enable As New SiteBoolean     ''set true when need to bin out, haven't been used yet

'''Dec For DVS bin 5 requirement,temp
Public glb_ModuleFailCount_BeforeDVS_slng As New SiteLong                   'Used to count the total number of failed modules before DVS
Public glb_ModuleFailCount_AfterDVS_slng As New SiteLong                    'Used to count the total number of failed modules after DVS
Public glb_UpdateBinNumerAfterDVSDone_sbool As New SiteBoolean              'Used to mark the action of updating binnumber after DVS
'Public glb_DFTRetestAfterDVS_sbool As New SiteBoolean                       'Used to mark the start and end of DFT test after DVS
Public glb_PG_DVSFirstFail_Flag_SBool As New SiteBoolean                    'Init False, record if the first fail Module of PostDVS is found, if found then glb_PG_DVSFirstFail_Flag_SBool=True
Public glb_PG_DVS_FisrtFail_BinNum_SLng As New SiteLong       'Record the first found BinNum in PostDVS
Public glb_PG_DVS_FisrtFail_SortNum_SLng As New SiteLong      'Record the first found SortNum in PostDVS


'''''''For DVS FLOW Only
Public Function PG_CalcModuleFailCountBeforeDVS_vbt() As Long

    On Error GoTo errHandler
'''''''''''''''''''
'Executed as a test item after DVS only in CPB_L40C flow,used to count the total number of failed modules for each pattern before DVS
'Test item execution condition is controlled by Flow Flag,which is DVS_FALG_ZORE=True

    Dim Site As Variant
    Dim tempPG_Dspwave_beforeDVS As New DSPWave
    Dim idx_Module As Long
    Dim i As Long
    Dim tempLocalDspwave As New DSPWave
    
    glb_ModuleFailCount_BeforeDVS_slng = 0
    
    
    For Each Site In TheExec.Sites
        tempPG_Dspwave_beforeDVS = glb_PG_FlowResult_Dspwave.Copy
        tempPG_Dspwave_beforeDVS = tempPG_Dspwave_beforeDVS.Select(glb_Module_Count + 2, 1, -1)           ''remove the inital dummy element
        For idx_Module = 0 To glb_Module_Count - 1
            tempLocalDspwave = tempPG_Dspwave_beforeDVS.Select(idx_Module, glb_Module_Count + 2, -1)
            glb_ModuleFailCount_BeforeDVS_slng = glb_ModuleFailCount_BeforeDVS_slng + tempLocalDspwave.CountElements(EqualTo, 0)
        Next idx_Module
        
        'glb_DFTRetestAfterDVS_sbool = True
        'the next part will be the DFT retest after DVS,and begin to record bin5,so set glb_DFTRetestAfterDVS_sbool to true
    Next Site

    Exit Function
errHandler:
    If AbortTest Then Exit Function Else Resume Next
End Function


'''''''For DVS FLOW Only
Public Function PG_CalcModuleFailCountAfterDVS(inLocalDspwave As DSPWave, inSortNumber_lng As Long) As Long


'''this function should be added at the end of every post pattern function, but it has three execution conditions
'''condition1: current flow should be DVS Flow
'''condition2: DVS_FALG_ZORE=True ,means DVS fresh
'''condition3: Testnumber should start with 5, indicating hardbin 5
'''condition4: glb_UpdateBinNumerAfterDVSDone_sbool=false

''glb_ModuleFailCount_AfterDVS_slng will be updated after every PG test
''When glb_ModuleFailCount_AfterDVS_slng is larger than glb_ModuleFailCount_BeforeDVS_slng,means some module is failed because of DVS,than bin number will be updated and locked

    On Error GoTo errHandler
    
    Dim Site As Variant
    Dim JobName As String
    
    Dim tempPG_Dspwave_AfterDVS As New DSPWave
    Dim tempLocalDspwave As New DSPWave
    Dim postpatDspwave As New DSPWave
    Dim idx_Module As Long
    Dim i As Long
    
    
    JobName = TheExec.CurrentJob
    If InStr(1, JobName, "CPB") > 1 And InStr(1, JobName, "_L40C") > 1 Then
        For Each Site In TheExec.Sites
            If Floor(inSortNumber_lng / 1000) = 5 And glb_UpdateBinNumerAfterDVSDone_sbool = False Then
                If TheExec.Sites(Site).FlagState("DVS_FALG_ZORE") = logicTrue Then
                    
                    'lock the first sort bin number in postDVS
                    If glb_PG_DVSFirstFail_Flag_SBool = False Then
                        postpatDspwave = inLocalDspwave.Copy
                        postpatDspwave = postpatDspwave.Select(0, 1, glb_Module_Count + 1)
                        If postpatDspwave.CountElements(EqualTo, 0) > 0 Then   ''means more than one module failed
                            glb_PG_DVSFirstFail_Flag_SBool = True
                            glb_PG_DVS_FisrtFail_SortNum_SLng = inSortNumber_lng
                            glb_PG_DVS_FisrtFail_BinNum_SLng = Floor(inSortNumber_lng / 1000)
                        End If
                    End If
                        
                     tempPG_Dspwave_AfterDVS = inLocalDspwave.Copy
                    tempPG_Dspwave_AfterDVS = tempPG_Dspwave_AfterDVS.Select(0, 1, glb_Module_Count)
                    

                    glb_ModuleFailCount_AfterDVS_slng = glb_ModuleFailCount_AfterDVS_slng + tempPG_Dspwave_AfterDVS.CountElements(EqualTo, 0)

                    'when the PG module fail count increased in postDVS larger than FailCount_BeforeDVS, means there must be some module failed because of DVS, then bin the first fail in postDVS
                    If glb_ModuleFailCount_AfterDVS_slng > glb_ModuleFailCount_BeforeDVS_slng Then
                        glb_PGFisrtFail_BinNum_SLng = glb_PG_DVS_FisrtFail_BinNum_SLng
                        glb_PGFisrtFail_SortNum_SLng = glb_PG_DVS_FisrtFail_SortNum_SLng
                        glb_UpdateBinNumerAfterDVSDone_sbool = True
                    End If
                Else
                    Err.Raise " DVS Logic Error: When Hard Bin5, DVS_FALG_ZORE should be True! "
                End If
            End If
        Next Site
    End If
    
    Exit Function
errHandler:
    If AbortTest Then Exit Function Else Resume Next
End Function

''''''''''For DVS FLOW Only
'''Public Function PG_DFTRetestAfterDVS_Done()
''''This function will be executed after bin5 tests are finished
'''Dim site As Variant
'''For Each site In TheExec.Sites
'''    glb_DFTRetestAfterDVS_sbool = False
'''Next site
'''End Function

Public Function PG_PreJudge(PatName As Pattern, _
                            Optional FlowTempFlag As String = "RT|HT|LT", _
                            Optional FlowFuncFlag As String = "FT|CP", _
                            Optional FlowFuncPart As String = "NA|A|B|C|D|E|Z", _
                            Optional FlowIsAVS As Boolean = False, _
                            Optional PreCheck_FlowTempFlag As String = "RT|HT|LT|NA", _
                            Optional PreCheck_FlowFuncFlag As String = "FT|CP|QA|OR|NA", _
                            Optional PreCheck_FlowFuncPart As String = "NA|A|B|C|D|E|Z", _
                            Optional PreCheck_FlowIsAVS As Boolean = False, _
                            Optional CheckPG As PFType, _
                            Optional ConnectAllPins As Boolean = True, _
                            Optional LoadLevels As Boolean = True, _
                            Optional LoadTiming As Boolean = True, _
                            Optional RelayMode As tlRelayMode = 1, _
                            Optional InitWaitTime As Double = 0, _
                            Optional Exec_Mode As Exec_Modes, _
                            Optional DriveLoPins As PinList, Optional DriveHiPins As PinList, Optional DriveZPins As PinList, _
                            Optional FloatPins As PinList, _
                            Optional util1Pins As PinList, Optional util0Pins As PinList) As Long


    On Error GoTo errHandler
    
    If glb_IsPGInfoLoaded_Bool = False Then
        Call Initialize_PG_Info
    End If

    Dim Idx As Long
    Dim idx_Module As Long
    
    Dim Site As Variant
    
'*************************************************************************************************
'*****Step1:Value inital for Global Variables*****************************************************
'*************************************************************************************************
    For Each Site In TheExec.Sites
        glb_PG_GRD_Sdbl = 0
        glb_PWR_GRD_Sdbl = 0
        glb_PGFirstFail_Flag_SBool = False
        glb_PGFirstFail_UpdateDone_SBool = False
        glb_BinOut_Enable = False
        glb_PGFisrtFail_BinNum_SLng = -9999
        glb_PGFisrtFail_SortNum_SLng = -9999
        glb_UpdateBinNumerAfterDVSDone_sbool = False
        'glb_DFTRetestAfterDVS_sbool = False
        glb_ModuleFailCount_BeforeDVS_slng = 0
        glb_ModuleFailCount_AfterDVS_slng = 0
        glb_PG_DVSFirstFail_Flag_SBool = False
        glb_PG_DVS_FisrtFail_BinNum_SLng = -9999
        glb_PG_DVS_FisrtFail_SortNum_SLng = -9999
        AVS_Enable = False
        PG_Judge_Slng = 0
    Next Site
    
    
'*************************************************************************************************
'*****Step2:Construct Current\PreCheck Flow PG Efuse Pass Flag Item Name *************************
'*************************************************************************************************
    CurrentFlowPGPassFlag.cItemName = "PG_PASS_FLAG_" & FlowTempFlag
     
    If FlowFuncPart = "NA" Then
        CurrentFlowPGPassFlag.cItemName = CurrentFlowPGPassFlag.cItemName & "_" & FlowFuncFlag
    Else
        CurrentFlowPGPassFlag.cItemName = CurrentFlowPGPassFlag.cItemName & "_" & FlowFuncFlag & FlowFuncPart
    End If
    
    If PreCheck_FlowTempFlag = "NA" And PreCheck_FlowFuncFlag = "NA" And PreCheck_FlowFuncPart = "NA" Then
        
        If glb_PG_DebugMode = True Then
            TheExec.Datalog.WriteComment " No Precheck Flow,PreCheckFlowPG Pass Flag doesn't exist"
        End If
    Else
        PreCheckFlowPGPassFlag.cItemName = "PG_PASS_FLAG_" & PreCheck_FlowTempFlag

        If PreCheck_FlowFuncPart = "NA" Then
            PreCheckFlowPGPassFlag.cItemName = PreCheckFlowPGPassFlag.cItemName & "_" & PreCheck_FlowFuncFlag
        Else
            PreCheckFlowPGPassFlag.cItemName = PreCheckFlowPGPassFlag.cItemName & "_" & PreCheck_FlowFuncFlag & PreCheck_FlowFuncPart
        End If
    End If
    
    
    Dim ModuleList_Str() As String
    ModuleList_Str = Split(USER_DEFINE_MODULENAME, "/")
    ReDim FlowModuleFlag(glb_Module_Count - 1)
    
'*************************************************************************************************
'*****Step2:Construct Current\PreCheck Flow Module Efuse Pass Flag Item Name *********************
'*************************************************************************************************
    If FlowIsAVS = True Then     ''means current flow is AVS flow, need two groups of Pass Flag(LP\HP)
        ReDim CurrentFlowModulePassFlag(glb_Module_Count * 2 - 1)
        For Idx = 0 To glb_Module_Count - 1
            CurrentFlowModulePassFlag(Idx).cItemName = ModuleList_Str(Idx) & "_" & MID(CurrentFlowPGPassFlag.cItemName, 4) & "_LP"
            TheExec.Flow.TestLimit ResultVal:=0, lowVal:=0, hiVal:=1, PinName:=CurrentFlowModulePassFlag(Idx).cItemName, ForceResults:=tlForceNone, TName:="CurrentFlowModulePassFlag"
            CurrentFlowModulePassFlag(Idx + glb_Module_Count).cItemName = ModuleList_Str(Idx) & "_" & MID(CurrentFlowPGPassFlag.cItemName, 4) & "_HP"
            TheExec.Flow.TestLimit ResultVal:=0, lowVal:=0, hiVal:=1, PinName:=CurrentFlowModulePassFlag(Idx + glb_Module_Count).cItemName, ForceResults:=tlForceNone, TName:="CurrentFlowModulePassFlag"
        Next Idx
    Else                        ''means current flow is None AVS flow, need one group of Pass Flag
       ReDim CurrentFlowModulePassFlag(glb_Module_Count - 1)
       For Idx = 0 To glb_Module_Count - 1
            CurrentFlowModulePassFlag(Idx).cItemName = ModuleList_Str(Idx) & "_" & MID(CurrentFlowPGPassFlag.cItemName, 4)
            TheExec.Flow.TestLimit ResultVal:=0, lowVal:=0, hiVal:=1, PinName:=CurrentFlowModulePassFlag(Idx).cItemName, ForceResults:=tlForceNone, TName:="CurrentFlowModulePassFlag"
        Next Idx
    End If
    
    
    If PreCheck_FlowTempFlag = "NA" And PreCheck_FlowFuncFlag = "NA" And PreCheck_FlowFuncPart = "NA" Then
        
        If glb_PG_DebugMode = True Then
            TheExec.Datalog.WriteComment " No Precheck Flow,PreCheckFlow Module Pass Flag doesn't exist"
        End If
    Else
        If PreCheck_FlowIsAVS = True Then  ''means precheck flow is AVS flow, need two groups of Pass Flag(LP\HP)
            ReDim PreCheckFlowModulePassFlag(glb_Module_Count * 2 - 1)
            For Idx = 0 To glb_Module_Count - 1
                PreCheckFlowModulePassFlag(Idx).cItemName = ModuleList_Str(Idx) & "_" & MID(PreCheckFlowPGPassFlag.cItemName, 4) & "_LP"
                PreCheckFlowModulePassFlag(Idx + glb_Module_Count).cItemName = ModuleList_Str(Idx) & "_" & MID(PreCheckFlowPGPassFlag.cItemName, 4) & "_HP"
            Next Idx
        Else                                ''means current flow is None AVS flow, need one group of Pass Flag
            ReDim PreCheckFlowModulePassFlag(glb_Module_Count - 1)
            For Idx = 0 To glb_Module_Count - 1
                PreCheckFlowModulePassFlag(Idx).cItemName = ModuleList_Str(Idx) & "_" & MID(PreCheckFlowPGPassFlag.cItemName, 4)
            Next Idx
        End If
    End If
    
    ''Construct Flow Module Flag Name
    For Idx = 0 To glb_Module_Count - 1
       FlowModuleFlag(Idx).cItemName = ModuleList_Str(Idx) & "_Flow_Flag"
    Next Idx
    
    
'*************************************************************************************************
'*****Step3:Set Flow Module Flag Value accroding to PreCheck Flow Result**************************
'*************************************************************************************************

    If PreCheck_FlowTempFlag = "NA" And PreCheck_FlowFuncFlag = "NA" And PreCheck_FlowFuncPart = "NA" Then
        
        '''if no precheck flow, set all FlowModule flag=1
        For idx_Module = 0 To glb_Module_Count - 1
            FlowModuleFlag(idx_Module).iValue = 1
            TheExec.Flow.TestLimit ResultVal:=FlowModuleFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=FlowModuleFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="FlowModuleFlag"
        Next idx_Module
     
    ElseIf PreCheck_FlowIsAVS = True Then
        '''if precheck flow is AVS Flow, Flow Module Flag value should be the or result of AVS_LP and AVS_HP result
            For Each Site In TheExec.Sites
        
                PreCheckFlowPGPassFlag.iValue = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(PreCheckFlowPGPassFlag.cItemName, 0, Site)
                TheExec.Flow.TestLimit ResultVal:=PreCheckFlowPGPassFlag.iValue, lowVal:=1, hiVal:=1, PinName:=PreCheckFlowPGPassFlag.cItemName, ForceResults:=tlForceNone, TName:="PreCheckFlowPGPassFlag"
                If PreCheckFlowPGPassFlag.iValue = 0 Then
                    For idx_Module = 0 To glb_Module_Count - 1
                        PreCheckFlowModulePassFlag(idx_Module).iValue = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(PreCheckFlowModulePassFlag(idx_Module).cItemName, 0, Site)
                        TheExec.Flow.TestLimit ResultVal:=PreCheckFlowModulePassFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=PreCheckFlowModulePassFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="PreCheckFlowModulePassFlag"
                        PreCheckFlowModulePassFlag(idx_Module + glb_Module_Count).iValue = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(PreCheckFlowModulePassFlag(idx_Module + glb_Module_Count).cItemName, 0, Site)
                        TheExec.Flow.TestLimit ResultVal:=PreCheckFlowModulePassFlag(idx_Module + glb_Module_Count).iValue, lowVal:=0, hiVal:=1, PinName:=PreCheckFlowModulePassFlag(idx_Module + glb_Module_Count).cItemName, ForceResults:=tlForceNone, TName:="PreCheckFlowModulePassFlag"
                        FlowModuleFlag(idx_Module).iValue = 1
                        TheExec.Flow.TestLimit ResultVal:=FlowModuleFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=FlowModuleFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="FlowModuleFlag"
                    Next idx_Module
                Else
                    For idx_Module = 0 To glb_Module_Count - 1
                        PreCheckFlowModulePassFlag(idx_Module).iValue = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(PreCheckFlowModulePassFlag(idx_Module).cItemName, 0, Site)
                        TheExec.Flow.TestLimit ResultVal:=PreCheckFlowModulePassFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=PreCheckFlowModulePassFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="PreCheckFlowModulePassFlag"
                        PreCheckFlowModulePassFlag(idx_Module + glb_Module_Count).iValue = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(PreCheckFlowModulePassFlag(idx_Module + glb_Module_Count).cItemName, 0, Site)
                        TheExec.Flow.TestLimit ResultVal:=PreCheckFlowModulePassFlag(idx_Module + glb_Module_Count).iValue, lowVal:=0, hiVal:=1, PinName:=PreCheckFlowModulePassFlag(idx_Module + glb_Module_Count).cItemName, ForceResults:=tlForceNone, TName:="PreCheckFlowModulePassFlag"
                        FlowModuleFlag(idx_Module).iValue = PreCheckFlowModulePassFlag(idx_Module).iValue Or PreCheckFlowModulePassFlag(idx_Module + glb_Module_Count).iValue
                        TheExec.Flow.TestLimit ResultVal:=FlowModuleFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=FlowModuleFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="FlowModuleFlag"
                    Next idx_Module
                End If
            Next Site
    Else
        '''if precheck flow is None AVS Flow, Flow Module Flag value should be the or result of precheck flow result
        For Each Site In TheExec.Sites
        
            PreCheckFlowPGPassFlag.iValue = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(PreCheckFlowPGPassFlag.cItemName, 0, Site)
            TheExec.Flow.TestLimit ResultVal:=PreCheckFlowPGPassFlag.iValue, lowVal:=1, hiVal:=1, PinName:=PreCheckFlowPGPassFlag.cItemName, ForceResults:=tlForceNone, TName:="PreCheckFlowPGPassFlag"
            If PreCheckFlowPGPassFlag.iValue = 0 Then
                For idx_Module = 0 To glb_Module_Count - 1
                    PreCheckFlowModulePassFlag(idx_Module).iValue = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(PreCheckFlowModulePassFlag(idx_Module).cItemName, 0, Site)
                    TheExec.Flow.TestLimit ResultVal:=PreCheckFlowModulePassFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=PreCheckFlowModulePassFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="PreCheckFlowModulePassFlag"
                    FlowModuleFlag(idx_Module).iValue = 1
                    TheExec.Flow.TestLimit ResultVal:=FlowModuleFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=FlowModuleFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="FlowModuleFlag"
                Next idx_Module
            Else
                For idx_Module = 0 To glb_Module_Count - 1
                    PreCheckFlowModulePassFlag(idx_Module).iValue = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(PreCheckFlowModulePassFlag(idx_Module).cItemName, 0, Site)
                    TheExec.Flow.TestLimit ResultVal:=PreCheckFlowModulePassFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=PreCheckFlowModulePassFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="PreCheckFlowModulePassFlag"
                    FlowModuleFlag(idx_Module).iValue = PreCheckFlowModulePassFlag(idx_Module).iValue
                    TheExec.Flow.TestLimit ResultVal:=FlowModuleFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=FlowModuleFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="FlowModuleFlag"
                Next idx_Module
            End If
        Next Site
    End If
    
    '''create dummy space,size=glb_Module_Count+2,because there is one element for other moudle and one element for TestNum
    Set glb_PG_FlowResult_Dspwave = New DSPWave
    Set glb_PG_FlowResult_AVS_Dspwave = New DSPWave
    glb_PG_FlowResult_Dspwave.CreateConstant -1, glb_Module_Count + 2, DspLong
    glb_PG_FlowResult_AVS_Dspwave.CreateConstant -1, (glb_Module_Count + 2) * 2, DspLong
    

    Exit Function
errHandler:
    If AbortTest Then Exit Function Else Resume Next

End Function



Public Function PG_UpdateNoneAVSModuleFlag(ByRef inout_OtherModulePassFlag As SiteLong) As Long
   
   On Error GoTo errHandler
''''This Function update the result in glb_PG_FlowResult_Dspwave to Current Module Flag
    Dim PG_FlowResult_Samplesize As Long
    Dim idx_Module As Long
    Dim i As Long
    Dim Site As Variant
    Dim errmsg As String
    
        For Each Site In TheExec.Sites
            glb_PG_FlowResult_Dspwave = glb_PG_FlowResult_Dspwave.Select(glb_Module_Count + 2, 1, -1)   ''remove the inital dummy element
            PG_FlowResult_Samplesize = glb_PG_FlowResult_Dspwave.SampleSize
            
            'set FlowModuleFlag.iValue as the inital value of ModulePassFlag
            For idx_Module = 0 To glb_Module_Count - 1
                CurrentFlowModulePassFlag(idx_Module).iValue = FlowModuleFlag(idx_Module).iValue
            Next idx_Module
    
            
            For i = 0 To PG_FlowResult_Samplesize - 1 Step glb_Module_Count + 2
                '''Update PG Result to Efuse FlowFlag_Module
                For idx_Module = 0 To glb_Module_Count - 1
                    If glb_PG_FlowResult_Dspwave.Element(i + idx_Module) = -1 Or glb_PG_FlowResult_Dspwave.Element(i + idx_Module) = 1 Then
                        CurrentFlowModulePassFlag(idx_Module).iValue = CurrentFlowModulePassFlag(idx_Module).iValue And 1
                    ElseIf glb_PG_FlowResult_Dspwave.Element(i + idx_Module) = 0 Then
                        CurrentFlowModulePassFlag(idx_Module).iValue = CurrentFlowModulePassFlag(idx_Module).iValue And 0
                    Else
                        'Fool proof,in case of wrong dspwave element assign
                        errmsg = "Error!!!The element in glb_PG_FlowResult_Dspwave can only be 0 or 1 or -1,not other numbers"
                        GoTo errHandler
                    End If
                Next idx_Module
                 '''Update other's Result to FlowFlag_other
                inout_OtherModulePassFlag = inout_OtherModulePassFlag And glb_PG_FlowResult_Dspwave.Element(i + idx_Module)
            Next i
            
            'Fool proof,inout_OtherModulePassFlag's value can only be 0 or 1,in case of wrong value assignment
            If inout_OtherModulePassFlag <> 0 And inout_OtherModulePassFlag <> 1 Then
                errmsg = "Error!!!The value of inout_OtherModulePassFlag can only be 0 or 1,not other numbers"
                GoTo errHandler
            End If
            
            ''Updating FlowModuleFlag when None AVS result processing done, it will be the inital value in AVS result Updating process
            For idx_Module = 0 To glb_Module_Count - 1
                FlowModuleFlag(idx_Module).iValue = CurrentFlowModulePassFlag(idx_Module).iValue
            Next idx_Module
            
        Next Site


    Exit Function
errHandler:

    TheExec.ErrorLogMessage ("PG_UpdateNoneAVSModuleFlag: " + errmsg)
    If AbortTest Then Exit Function Else Resume Next

End Function
Public Function PG_UpdateAVSModuleFlag(ByRef inout_OtherModulePassFlag_LP As SiteLong, ByRef inout_OtherModulePassFlag_HP As SiteLong) As Long
    
    
    On Error GoTo errHandler
''''This Function update the result in glb_PG_FlowResult_AVS_Dspwave to Current Module Flag
    Dim PG_FlowResult_AVS_Samplesize As Long
    Dim idx_Module As Long
    Dim i As Long
    Dim errmsg As String
    
    Dim Site As Variant
        For Each Site In TheExec.Sites
            
            glb_PG_FlowResult_AVS_Dspwave = glb_PG_FlowResult_AVS_Dspwave.Select((glb_Module_Count + 2) * 2, 1, -1)   ''remove the inital dummy element
            PG_FlowResult_AVS_Samplesize = glb_PG_FlowResult_AVS_Dspwave.SampleSize
            
            'the FlowModuleFlag.iValue has been updated when calling PG_UpdateNoneAVSModuleFlag function, so they should be the inital value of LP and HP flag
            For idx_Module = 0 To glb_Module_Count - 1
                CurrentFlowModulePassFlag(idx_Module).iValue = FlowModuleFlag(idx_Module).iValue
                CurrentFlowModulePassFlag(idx_Module + glb_Module_Count).iValue = FlowModuleFlag(idx_Module).iValue
            Next idx_Module
            
            For i = 0 To PG_FlowResult_AVS_Samplesize - 1 Step (glb_Module_Count + 2) * 2
                For idx_Module = 0 To glb_Module_Count - 1
                    
                    '''Update AVS LP Result to Efuse FlowFlag_Module
                    If glb_PG_FlowResult_AVS_Dspwave.Element(i + idx_Module) = -1 Or glb_PG_FlowResult_AVS_Dspwave.Element(i + idx_Module) = 1 Then
                        CurrentFlowModulePassFlag(idx_Module).iValue = CurrentFlowModulePassFlag(idx_Module).iValue And 1
                    ElseIf glb_PG_FlowResult_AVS_Dspwave.Element(i + idx_Module) = 0 Then
                        CurrentFlowModulePassFlag(idx_Module).iValue = CurrentFlowModulePassFlag(idx_Module).iValue And 0
                    Else
                        'Fool proof,in case of wrong dspwave element assign
                        errmsg = "Error!!!The element in glb_PG_FlowResult_AVS_Dspwave can only be 0 or 1 or -1,not other numbers"
                        GoTo errHandler
                    End If
                    
                    '''Update AVS HP Result to Efuse FlowFlag_Module
                    If glb_PG_FlowResult_AVS_Dspwave.Element(i + idx_Module + glb_Module_Count + 2) = -1 Or glb_PG_FlowResult_AVS_Dspwave.Element(i + idx_Module + glb_Module_Count + 2) = 1 Then
                        CurrentFlowModulePassFlag(idx_Module + glb_Module_Count).iValue = CurrentFlowModulePassFlag(idx_Module + glb_Module_Count).iValue And 1
                    ElseIf glb_PG_FlowResult_AVS_Dspwave.Element(i + idx_Module + glb_Module_Count + 2) = 0 Then
                        CurrentFlowModulePassFlag(idx_Module + glb_Module_Count).iValue = CurrentFlowModulePassFlag(idx_Module + glb_Module_Count).iValue And 0
                    Else
                        'Fool proof,in case of wrong dspwave element assign
                        errmsg = "Error!!!The element in glb_PG_FlowResult_AVS_Dspwave can only be 0 or 1 or -1,not other numbers"
                        GoTo errHandler
                    End If
                    
                Next idx_Module
                    '''Update other's Result to FlowFlag_other
                inout_OtherModulePassFlag_LP = inout_OtherModulePassFlag_LP And glb_PG_FlowResult_AVS_Dspwave.Element(i + idx_Module)
                inout_OtherModulePassFlag_HP = inout_OtherModulePassFlag_HP And glb_PG_FlowResult_AVS_Dspwave.Element(i + idx_Module + glb_Module_Count + 2)
            Next i
            
            'Fool proof,inout_OtherModulePassFlag's value can only be 0 or 1,in case of wrong value assignment
            If inout_OtherModulePassFlag_LP <> 0 And inout_OtherModulePassFlag_LP <> 1 And inout_OtherModulePassFlag_HP <> 0 And inout_OtherModulePassFlag_HP <> 1 Then
                errmsg = "Error!!!The value of inout_OtherModulePassFlag can only be 0 or 1,not other numbers"
                GoTo errHandler
            End If
            
        Next Site

    Exit Function
errHandler:

    TheExec.ErrorLogMessage ("PG_UpdateAVSModuleFlag: " + errmsg)
    If AbortTest Then Exit Function Else Resume Next

End Function

Public Function PG_PostJudge(Optional FlowIsAVS As Boolean = False) As Long

On Error GoTo errHandler

    Dim i As Long
    Dim idx_Module As Long
    Dim Site As Variant
    Dim errmsg As String
    Dim JobName As String
    JobName = TheExec.CurrentJob
     
    
    Dim FlowModulePassFlagWriteIndex_lng As Long
    Dim CurrentFlowModulePassFlagFromEfuse As Long
    Dim ModuleRetestBecomeFail As Long
    
    
    Dim LocalDSPS_Dspwave As New DSPWave
    Dim LocalFFT_Dspwave As New DSPWave
    Dim LocalSAMP_Dspwave As New DSPWave
    Dim LocalDSPS_AVSLP_Dspwave As New DSPWave
    Dim LocalFFT_AVSLP_Dspwave As New DSPWave
    Dim LocalSAMP_AVSLP_Dspwave As New DSPWave
    Dim LocalDSPS_AVSHP_Dspwave As New DSPWave
    Dim LocalFFT_AVSHP_Dspwave As New DSPWave
    Dim LocalSAMP_AVSHP_Dspwave As New DSPWave
    
    Dim OtherModulePassFlag As New SiteLong: OtherModulePassFlag = 1
    Dim OtherModulePassFlag_LP As New SiteLong 'only used in AVS flow
    Dim OtherModulePassFlag_HP As New SiteLong 'only used in AVS flow
    
    Dim DSP_ModuleFailCount_slng As New SiteLong
    Dim FFT_ModuleFailCount_slng As New SiteLong
    Dim SAMP_ModuleFailCount_slng As New SiteLong
    Dim DSP_AVSLP_ModuleFailCount_slng As New SiteLong
    Dim FFT_AVSLP_ModuleFailCount_slng As New SiteLong
    Dim SAMP_AVSLP_ModuleFailCount_slng As New SiteLong
    Dim DSP_AVSHP_ModuleFailCount_slng As New SiteLong
    Dim FFT_AVSHP_ModuleFailCount_slng As New SiteLong
    Dim SAMP_AVSHP_ModuleFailCount_slng As New SiteLong
    
    If FlowIsAVS = True Then    '''Means AVS Flow
    
    
    
        Call PG_UpdateNoneAVSModuleFlag(OtherModulePassFlag)
        
        '''in AVS flow,PG_UpdateNoneAVSModuleFlag must be called before PG_UpdateAVSModuleFlag,because the inital value of LP&HP Flag should based on None AVS PG result
        
        OtherModulePassFlag_LP = OtherModulePassFlag
        OtherModulePassFlag_HP = OtherModulePassFlag
        
        Call PG_UpdateAVSModuleFlag(OtherModulePassFlag_LP, OtherModulePassFlag_HP)
        
        
        
        '''Datalog all module flag and update them to efuse PGM
        For Each Site In TheExec.Sites
            
            CurrentFlowPGPassFlag.iValue = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(CurrentFlowPGPassFlag.cItemName, 0, Site)
            TheExec.Flow.TestLimit ResultVal:=CurrentFlowPGPassFlag.iValue, lowVal:=0, hiVal:=1, PinName:=CurrentFlowPGPassFlag.cItemName, ForceResults:=tlForceNone, TName:="CurrentFlowPGPassFlag"
            
            For idx_Module = 0 To glb_Module_Count * 2 - 1
                CurrentFlowModulePassFlagFromEfuse = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(CurrentFlowModulePassFlag(idx_Module).cItemName, 0, Site)
                TheExec.Flow.TestLimit ResultVal:=CurrentFlowModulePassFlagFromEfuse, lowVal:=0, hiVal:=1, PinName:=CurrentFlowModulePassFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="CurrentFlowModulePassFlagFromEfuse"
                If CurrentFlowModulePassFlagFromEfuse = 1 And CurrentFlowModulePassFlag(idx_Module).iValue = 0 Then
                    ModuleRetestBecomeFail = 1
                    TheExec.Sites(Site).BinNumber = 6
                    TheExec.Sites(Site).SortNumber = 6996
                    TheExec.Sites(Site).Result = tlResultFail
                Else
                    ModuleRetestBecomeFail = 0
                End If
                TheExec.Flow.TestLimit ResultVal:=ModuleRetestBecomeFail, lowVal:=0, hiVal:=0, PinName:=CurrentFlowModulePassFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="ModuleRetestBecomeFail"
            Next idx_Module
                        
            For idx_Module = 0 To glb_Module_Count - 1
                TheExec.Flow.TestLimit ResultVal:=CurrentFlowModulePassFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=CurrentFlowModulePassFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="FlowModulePassFlag"
                TheExec.Flow.TestLimit ResultVal:=CurrentFlowModulePassFlag(idx_Module + glb_Module_Count).iValue, lowVal:=0, hiVal:=1, PinName:=CurrentFlowModulePassFlag(idx_Module + glb_Module_Count).cItemName, ForceResults:=tlForceNone, TName:="FlowModulePassFlag"
                Call HiEfuse.MULT_EFUSE_ITEM_UPDATE(CurrentFlowModulePassFlag(idx_Module).cItemName, 0, CLng(Site), CDbl(CurrentFlowModulePassFlag(idx_Module).iValue), 0, False)
                Call HiEfuse.MULT_EFUSE_ITEM_UPDATE(CurrentFlowModulePassFlag(idx_Module + glb_Module_Count).cItemName, 0, CLng(Site), CDbl(CurrentFlowModulePassFlag(idx_Module + glb_Module_Count).iValue), 0, False)
            Next idx_Module
            TheExec.Flow.TestLimit ResultVal:=OtherModulePassFlag, lowVal:=0, hiVal:=1, PinName:="Other_NoneAVS", ForceResults:=tlForceNone, TName:="FlowModulePassFlag"
            TheExec.Flow.TestLimit ResultVal:=OtherModulePassFlag_LP, lowVal:=0, hiVal:=1, PinName:="Other_LP", ForceResults:=tlForceNone, TName:="FlowModulePassFlag"
            TheExec.Flow.TestLimit ResultVal:=OtherModulePassFlag_HP, lowVal:=0, hiVal:=1, PinName:="Other_HP", ForceResults:=tlForceNone, TName:="FlowModulePassFlag"
    
            LocalDSPS_AVSLP_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_DSPSCluster, CurrentFlowModulePassFlag, False).Copy
            LocalFFT_AVSLP_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_FFTCluster, CurrentFlowModulePassFlag, False).Copy
            LocalSAMP_AVSLP_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_SAMPCluster, CurrentFlowModulePassFlag, False).Copy
            LocalDSPS_AVSHP_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_DSPSCluster, CurrentFlowModulePassFlag, True).Copy
            LocalFFT_AVSHP_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_FFTCluster, CurrentFlowModulePassFlag, True).Copy
            LocalSAMP_AVSHP_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_SAMPCluster, CurrentFlowModulePassFlag, True).Copy
            
    
    
            DSP_AVSLP_ModuleFailCount_slng = LocalDSPS_AVSLP_Dspwave.CountElements(EqualTo, 0)
            FFT_AVSLP_ModuleFailCount_slng = LocalFFT_AVSLP_Dspwave.CountElements(EqualTo, 0)
            SAMP_AVSLP_ModuleFailCount_slng = LocalSAMP_AVSLP_Dspwave.CountElements(EqualTo, 0)
            DSP_AVSHP_ModuleFailCount_slng = LocalDSPS_AVSHP_Dspwave.CountElements(EqualTo, 0)
            FFT_AVSHP_ModuleFailCount_slng = LocalFFT_AVSHP_Dspwave.CountElements(EqualTo, 0)
            SAMP_AVSHP_ModuleFailCount_slng = LocalSAMP_AVSHP_Dspwave.CountElements(EqualTo, 0)
            
          '''judge partial and set fail bin
            If OtherModulePassFlag_LP = 1 And DSP_AVSLP_ModuleFailCount_slng = 0 And FFT_AVSLP_ModuleFailCount_slng = 0 And SAMP_AVSLP_ModuleFailCount_slng = 0 Then
            ''' LP Full good
                PG_Judge_Slng = 1
                If glb_PG_DebugMode = True Then
                    TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip is LP Full Good According to PG Pattern Result"
                    TheExec.Datalog.WriteComment "Site:" & Site & "_PGFirstFail_SortNum is " & glb_PGFisrtFail_SortNum_SLng
    
                    If TheExec.Sites(Site).FirstSortNumber = -1 And TheExec.Sites(Site).FirstBinNumber = -1 Then
                        TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip has no other none PG tests failed."
                    Else
                        TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip has some other none PG tests failed."
                    End If
                End If
                
            ElseIf OtherModulePassFlag_HP = 1 And DSP_AVSHP_ModuleFailCount_slng = 0 And FFT_AVSHP_ModuleFailCount_slng = 0 And SAMP_AVSHP_ModuleFailCount_slng = 0 Then
            ''' HP Full good
                PG_Judge_Slng = 1
                If glb_PG_DebugMode = True Then
                    TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip is HP Full Good According to PG Pattern Result"
                    TheExec.Datalog.WriteComment "Site:" & Site & "_PGFirstFail_SortNum is " & glb_PGFisrtFail_SortNum_SLng
        
                    If TheExec.Sites(Site).FirstSortNumber = -1 And TheExec.Sites(Site).FirstBinNumber = -1 Then
                        TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip has no other none PG tests failed."
                    Else
                        TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip has some other none PG tests failed."
                    End If
                End If
                
            ElseIf OtherModulePassFlag_LP = 1 And DSP_AVSLP_ModuleFailCount_slng <= 1 And FFT_AVSLP_ModuleFailCount_slng <= 1 And SAMP_AVSLP_ModuleFailCount_slng <= 1 Then
            '''LP PG1
                PG_Judge_Slng = 8
                If glb_PG_DebugMode = True Then
                    TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip is LP PG1 According to PG Pattern Result"
                    TheExec.Datalog.WriteComment "Site:" & Site & "_PGFirstFail_SortNum is " & glb_PGFisrtFail_SortNum_SLng
        
                    If TheExec.Sites(Site).FirstSortNumber = -1 And TheExec.Sites(Site).FirstBinNumber = -1 Then
                        TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip has no other none PG tests failed."
                    Else
                        TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip has some other none PG tests failed."
                    End If
                End If
                
            Else
            ''''fail die
                PG_Judge_Slng = 9
                If glb_PG_DebugMode = True Then
                    TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip is Fail Die According to PG Pattern Result"
                    TheExec.Datalog.WriteComment "Site:" & Site & "_PGFirstFail_SortNum is " & glb_PGFisrtFail_SortNum_SLng
                End If
                
                If TheExec.Sites(Site).FirstSortNumber = -1 And TheExec.Sites(Site).FirstBinNumber = -1 And _
                    TheExec.Sites(Site).SortNumber = -1 And TheExec.Sites(Site).BinNumber = -1 Then
                    If glb_PGFisrtFail_SortNum_SLng <> -9999 Then
                        TheExec.Sites(Site).BinNumber = glb_PGFisrtFail_BinNum_SLng
                        TheExec.Sites(Site).SortNumber = glb_PGFisrtFail_SortNum_SLng
                        TheExec.Sites(Site).Result = tlResultFail
                       
                    Else
                        'TheExec.Datalog.WriteComment "Site:" & Site & "_Warning!!!The  sort number is not supposed to be -9999here, there must be something wrong in the code!"
                        errmsg = "Warning!!!The  sort number is not supposed to be -9999here, there must be something wrong in the code!"
                        GoTo errHandler
                    End If
                End If
                    
            End If
            
            'Connect the OtherModulePassFlag_LP with "PWR_GRD_NOPG" EFUSE ITEM, so the last flow will get the other module LP pass fail information in AVS flow
            If OtherModulePassFlag_LP = 0 Then
                PWR_GRD_value = 2
            End If
           
        Next Site
    
    
    Else    '''Means Non AVS Flow
        
        
        Call PG_UpdateNoneAVSModuleFlag(OtherModulePassFlag)
        
            '''Datalog all module flag and update them to efuse PGM
        For Each Site In TheExec.Sites
            
            CurrentFlowPGPassFlag.iValue = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(CurrentFlowPGPassFlag.cItemName, 0, Site)
            TheExec.Flow.TestLimit ResultVal:=CurrentFlowPGPassFlag.iValue, lowVal:=0, hiVal:=1, PinName:=CurrentFlowPGPassFlag.cItemName, ForceResults:=tlForceNone, TName:="CurrentFlowPGPassFlag"
            
            For idx_Module = 0 To glb_Module_Count - 1
                CurrentFlowModulePassFlagFromEfuse = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD(CurrentFlowModulePassFlag(idx_Module).cItemName, 0, Site)
                TheExec.Flow.TestLimit ResultVal:=CurrentFlowModulePassFlagFromEfuse, lowVal:=0, hiVal:=1, PinName:=CurrentFlowModulePassFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="CurrentFlowModulePassFlagFromEfuse"
                If CurrentFlowModulePassFlagFromEfuse = 1 And CurrentFlowModulePassFlag(idx_Module).iValue = 0 Then
                    ModuleRetestBecomeFail = 1
                    TheExec.Sites(Site).BinNumber = 6
                    TheExec.Sites(Site).SortNumber = 6996
                    TheExec.Sites(Site).Result = tlResultFail
                Else
                    ModuleRetestBecomeFail = 0
                End If
                TheExec.Flow.TestLimit ResultVal:=ModuleRetestBecomeFail, lowVal:=0, hiVal:=0, PinName:=CurrentFlowModulePassFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="ModuleRetestBecomeFail"
            Next idx_Module
            
            For idx_Module = 0 To glb_Module_Count - 1
                TheExec.Flow.TestLimit ResultVal:=CurrentFlowModulePassFlag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=CurrentFlowModulePassFlag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="FlowModulePassFlag"
                If InStr(1, JobName, "FTZ") = 0 Then
                Call HiEfuse.MULT_EFUSE_ITEM_UPDATE(CurrentFlowModulePassFlag(idx_Module).cItemName, 0, CLng(Site), CDbl(CurrentFlowModulePassFlag(idx_Module).iValue), 0, False)
                End If
            
            Next idx_Module
            TheExec.Flow.TestLimit ResultVal:=OtherModulePassFlag, lowVal:=0, hiVal:=1, PinName:="Other", ForceResults:=tlForceNone, TName:="FlowModulePassFlag"
    
        
        
            LocalDSPS_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_DSPSCluster, CurrentFlowModulePassFlag, False).Copy
            LocalFFT_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_FFTCluster, CurrentFlowModulePassFlag, False).Copy
            LocalSAMP_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_SAMPCluster, CurrentFlowModulePassFlag, False).Copy
            
        
            DSP_ModuleFailCount_slng = LocalDSPS_Dspwave.CountElements(EqualTo, 0)
            FFT_ModuleFailCount_slng = LocalFFT_Dspwave.CountElements(EqualTo, 0)
            SAMP_ModuleFailCount_slng = LocalSAMP_Dspwave.CountElements(EqualTo, 0)
                                
                    If OtherModulePassFlag = 1 And DSP_ModuleFailCount_slng = 0 And FFT_ModuleFailCount_slng = 0 And SAMP_ModuleFailCount_slng = 0 Then
                    '''Full good
                        PG_Judge_Slng = 1
                        If glb_PG_DebugMode = True Then
                            TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip is Full Good According to PG Pattern Result"
                            TheExec.Datalog.WriteComment "Site:" & Site & "_PGFirstFail_SortNum is " & glb_PGFisrtFail_SortNum_SLng
                            
                            If TheExec.Sites(Site).FirstSortNumber = -1 And TheExec.Sites(Site).FirstBinNumber = -1 Then
                                TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip has no other none PG tests failed."
                            Else
                                TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip has some other none PG tests failed."
                            End If
                        End If
                        
                    ElseIf OtherModulePassFlag = 1 And DSP_ModuleFailCount_slng <= 1 And FFT_ModuleFailCount_slng <= 1 And SAMP_ModuleFailCount_slng <= 1 Then
                    '''PG1
                        PG_Judge_Slng = 8
                        If glb_PG_DebugMode = True Then
                            TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip is PG1 According to PG Pattern Result"
                            TheExec.Datalog.WriteComment "Site:" & Site & "_PGFirstFail_SortNum is " & glb_PGFisrtFail_SortNum_SLng
        
                            If TheExec.Sites(Site).FirstSortNumber = -1 And TheExec.Sites(Site).FirstBinNumber = -1 Then
                                TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip has no other none PG tests failed."
                            Else
                                TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip has some other none PG tests failed."
                            End If
                        End If
                        
                    Else
                    ''''fail die
                        PG_Judge_Slng = 9
                        If glb_PG_DebugMode = True Then
                            TheExec.Datalog.WriteComment "Site:" & Site & "_This Chip is Fail Die According to PG Pattern Result"
                            TheExec.Datalog.WriteComment "Site:" & Site & "_PGFirstFail_SortNum is " & glb_PGFisrtFail_SortNum_SLng
                        End If
                        
                        If TheExec.Sites(Site).FirstSortNumber = -1 And TheExec.Sites(Site).FirstBinNumber = -1 And _
                            TheExec.Sites(Site).SortNumber = -1 And TheExec.Sites(Site).BinNumber = -1 Then
                            If glb_PGFisrtFail_SortNum_SLng <> -9999 Then
                                TheExec.Sites(Site).BinNumber = glb_PGFisrtFail_BinNum_SLng
                                TheExec.Sites(Site).SortNumber = glb_PGFisrtFail_SortNum_SLng
                                TheExec.Sites(Site).Result = tlResultFail
                               
                            Else
                                'TheExec.Datalog.WriteComment "Site:" & Site & "_Warning!!!The  sort number is not supposed to be -9999here, there must be something wrong in the code!"
                                errmsg = "Warning!!!The  sort number is not supposed to be -9999here, there must be something wrong in the code!"
                                GoTo errHandler
                            End If
                        End If
                            
                    End If
        Next Site
    End If
    
        TheExec.Flow.TestLimit ResultVal:=PG_Judge_Slng, PinName:="PG_GRD", ForceResults:=tlForceFlow, TName:="PG_GRD_PostJudge"
        
        
        
        
        'Declaration For PostJudge in FT 25C flow
        Dim Module_LastFlow_Flag() As Type_PartialGood_Flag  'record module result calc form FT_105C and FT_25C,include LP&HP result
        Dim iPWR_GRD_NOPG As New SiteLong
        
        Dim LocalDSPS_AVSLP_LastFlow_Dspwave As New DSPWave
        Dim LocalFFT_AVSLP_LastFlow_Dspwave As New DSPWave
        Dim LocalSAMP_AVSLP_LastFlow_Dspwave As New DSPWave
        Dim LocalDSPS_AVSHP_LastFlow_Dspwave As New DSPWave
        Dim LocalFFT_AVSHP_LastFlow_Dspwave As New DSPWave
        Dim LocalSAMP_AVSHP_LastFlow_Dspwave As New DSPWave
        
        
    
        Dim DSP_AVSLP_ModuleFailCount_LastFlow_slng As New SiteLong
        Dim FFT_AVSLP_ModuleFailCount_LastFlow_slng As New SiteLong
        Dim SAMP_AVSLP_ModuleFailCount_LastFlow_slng As New SiteLong
        Dim DSP_AVSHP_ModuleFailCount_LastFlow_slng As New SiteLong
        Dim FFT_AVSHP_ModuleFailCount_LastFlow_slng As New SiteLong
        Dim SAMP_AVSHP_ModuleFailCount_LastFlow_slng As New SiteLong
        
        
    '*************************************************************************************************
    '*****FT 25C Only,AVS&Partial Grade Judge And Efuse Update ***************************************
    '*************************************************************************************************

        'only FT 25C flow run the follow process, used for AVS&partial grade judge
        If InStr(1, JobName, "FTA") > 1 Then
            If InStr(1, JobName, "_25C") > 1 Then
                Dim ModuleList_Str() As String
                ModuleList_Str = Split(USER_DEFINE_MODULENAME, "/")
                ReDim Module_LastFlow_Flag(glb_Module_Count * 2 - 1)
                
                ''Construct flag name
                For idx_Module = 0 To glb_Module_Count - 1
                    Module_LastFlow_Flag(idx_Module).cItemName = ModuleList_Str(idx_Module) & "_LastFlow_Flag" & "_LP"
                    Module_LastFlow_Flag(idx_Module + glb_Module_Count).cItemName = ModuleList_Str(idx_Module) & "_LastFlow_Flag" & "_HP"
                Next idx_Module
                
                ''Set flag value
                For Each Site In TheExec.Sites
                    For idx_Module = 0 To glb_Module_Count - 1
                        Module_LastFlow_Flag(idx_Module).iValue = PreCheckFlowModulePassFlag(idx_Module).iValue And CurrentFlowModulePassFlag(idx_Module).iValue
                        Module_LastFlow_Flag(idx_Module + glb_Module_Count).iValue = PreCheckFlowModulePassFlag(idx_Module + glb_Module_Count).iValue And CurrentFlowModulePassFlag(idx_Module).iValue
                        TheExec.Flow.TestLimit ResultVal:=Module_LastFlow_Flag(idx_Module).iValue, lowVal:=0, hiVal:=1, PinName:=Module_LastFlow_Flag(idx_Module).cItemName, ForceResults:=tlForceNone, TName:="Module_LastFlow_Flag"
                        TheExec.Flow.TestLimit ResultVal:=Module_LastFlow_Flag(idx_Module + glb_Module_Count).iValue, lowVal:=0, hiVal:=1, PinName:=Module_LastFlow_Flag(idx_Module + glb_Module_Count).cItemName, ForceResults:=tlForceNone, TName:="Module_LastFlow_Flag"
                    Next idx_Module
                    
                    iPWR_GRD_NOPG = HiEfuse.GET_MULT_EFUSE_ITEM_CODE_RD("PWR_GRD_NOPG", 0, Site)
    
                    
                ''calc fail elements
                    LocalDSPS_AVSLP_LastFlow_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_DSPSCluster, Module_LastFlow_Flag, False).Copy
                    LocalFFT_AVSLP_LastFlow_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_FFTCluster, Module_LastFlow_Flag, False).Copy
                    LocalSAMP_AVSLP_LastFlow_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_SAMPCluster, Module_LastFlow_Flag, False).Copy
                    LocalDSPS_AVSHP_LastFlow_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_DSPSCluster, Module_LastFlow_Flag, True).Copy
                    LocalFFT_AVSHP_LastFlow_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_FFTCluster, Module_LastFlow_Flag, True).Copy
                    LocalSAMP_AVSHP_LastFlow_Dspwave = PG_LocalDspWave_UpdateBy_UserDefineModule(USER_DEFINE_SAMPCluster, Module_LastFlow_Flag, True).Copy
    
    
                    DSP_AVSLP_ModuleFailCount_LastFlow_slng = LocalDSPS_AVSLP_LastFlow_Dspwave.CountElements(EqualTo, 0)
                    FFT_AVSLP_ModuleFailCount_LastFlow_slng = LocalFFT_AVSLP_LastFlow_Dspwave.CountElements(EqualTo, 0)
                    SAMP_AVSLP_ModuleFailCount_LastFlow_slng = LocalSAMP_AVSLP_LastFlow_Dspwave.CountElements(EqualTo, 0)
                    DSP_AVSHP_ModuleFailCount_LastFlow_slng = LocalDSPS_AVSHP_LastFlow_Dspwave.CountElements(EqualTo, 0)
                    FFT_AVSHP_ModuleFailCount_LastFlow_slng = LocalFFT_AVSHP_LastFlow_Dspwave.CountElements(EqualTo, 0)
                    SAMP_AVSHP_ModuleFailCount_LastFlow_slng = LocalSAMP_AVSHP_LastFlow_Dspwave.CountElements(EqualTo, 0)
                
                ''Partial Judge
                    If iPWR_GRD_NOPG = 1 And DSP_AVSLP_ModuleFailCount_LastFlow_slng = 0 And FFT_AVSLP_ModuleFailCount_LastFlow_slng = 0 And SAMP_AVSLP_ModuleFailCount_LastFlow_slng = 0 Then
                        ''LP Full Good
                        glb_PG_GRD_Sdbl = 3
                        glb_PWR_GRD_Sdbl = 1
                    ElseIf DSP_AVSHP_ModuleFailCount_LastFlow_slng = 0 And FFT_AVSHP_ModuleFailCount_LastFlow_slng = 0 And SAMP_AVSHP_ModuleFailCount_LastFlow_slng = 0 Then
                        ''HP Full Good
                        glb_PG_GRD_Sdbl = 3
                        glb_PWR_GRD_Sdbl = 2
                    ElseIf iPWR_GRD_NOPG = 1 And DSP_AVSLP_ModuleFailCount_LastFlow_slng <= 1 And FFT_AVSLP_ModuleFailCount_LastFlow_slng <= 1 And SAMP_AVSLP_ModuleFailCount_LastFlow_slng <= 1 Then
                        ''LP Partial Good
                        glb_PG_GRD_Sdbl = 1
                        glb_PWR_GRD_Sdbl = 3
                    Else
                        ''fail die, bin out here
                        glb_PG_GRD_Sdbl = 0
                        glb_PWR_GRD_Sdbl = 0
                        TheExec.Sites(Site).BinNumber = 6
                        TheExec.Sites(Site).SortNumber = 6998
                        TheExec.Sites(Site).Result = tlResultFail
                    End If
                    
                    Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("PG_GRD", 0, CLng(Site), glb_PG_GRD_Sdbl(Site), 0, False)
                    Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("PWR_GRD", 0, CLng(Site), glb_PWR_GRD_Sdbl(Site), 0, False)
                    
                    
                    If glb_PWR_GRD_Sdbl = 1 Or glb_PWR_GRD_Sdbl = 3 Then
                        ''''In LP case, update the first harf of Module_LastFlow_Flag,which means LP Result calc from all flow
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("DSPS0_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(0).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("DSPS1_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(1).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("DSPS2_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(2).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("DSPS3_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(3).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("FFT0_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(4).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("FFT1_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(5).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("SAMPLE0_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(6).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("SAMPLE1_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(7).iValue), 0, False)
                    ElseIf glb_PWR_GRD_Sdbl = 2 Then
                        ''''In HP case, update the last harf of Module_LastFlow_Flag,which means HP Result calc from all flow
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("DSPS0_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(8).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("DSPS1_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(9).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("DSPS2_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(10).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("DSPS3_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(11).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("FFT0_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(12).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("FFT1_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(13).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("SAMPLE0_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(14).iValue), 0, False)
                        Call HiEfuse.MULT_EFUSE_ITEM_UPDATE("SAMPLE1_PAGD_PASS_FLAG", 0, CLng(Site), CDbl(Module_LastFlow_Flag(15).iValue), 0, False)
                    End If
                    
                Next Site
            End If
        End If

Exit Function
errHandler:
    TheExec.ErrorLogMessage ("*E* PG.PostJudge: " + errmsg)
    If AbortTest Then Exit Function Else Resume Next
End Function
